import { Vulnerability } from './types';

/**
 * Static analysis patterns for common vulnerabilities
 */
export const VULNERABILITY_PATTERNS = {
  // Injection vulnerabilities
  SQL_INJECTION: {
    pattern: /(exec\(|eval\(|system\(|os\.system|subprocess\.|SELECT.*FROM.*WHERE|INSERT INTO|UPDATE.*SET|DELETE FROM)/gi,
    type: 'SQL/Command Injection',
    severity: 'critical' as const,
    cwe: 'CWE-89, CWE-78'
  },
  
  // XSS vulnerabilities
  XSS: {
    pattern: /(innerHTML|outerHTML|document\.write|dangerouslySetInnerHTML|\$\(.*\)\.html\()/gi,
    type: 'Cross-Site Scripting (XSS)',
    severity: 'high' as const,
    cwe: 'CWE-79'
  },
  
  // Hardcoded secrets
  HARDCODED_SECRETS: {
    pattern: /(password\s*=\s*["'][^"']+["']|api[_-]?key\s*=\s*["'][^"']+["']|secret\s*=\s*["'][^"']+["']|token\s*=\s*["'][^"']+["'])/gi,
    type: 'Hardcoded Credentials',
    severity: 'critical' as const,
    cwe: 'CWE-798'
  },
  
  // Path traversal
  PATH_TRAVERSAL: {
    pattern: /(\.\.\/|\.\.\\|open\(.*\+|readFile\(.*\+|fs\.read.*\(.*\+)/gi,
    type: 'Path Traversal',
    severity: 'high' as const,
    cwe: 'CWE-22'
  },
  
  // Insecure deserialization
  INSECURE_DESERIALIZATION: {
    pattern: /(pickle\.loads|yaml\.load\(|eval\(|JSON\.parse\(.*user|unserialize\()/gi,
    type: 'Insecure Deserialization',
    severity: 'critical' as const,
    cwe: 'CWE-502'
  },
  
  // Weak cryptography
  WEAK_CRYPTO: {
    pattern: /(md5|sha1|DES|RC4|ECB|crypto\.createCipher\()/gi,
    type: 'Weak Cryptography',
    severity: 'medium' as const,
    cwe: 'CWE-327'
  },
  
  // Unvalidated redirects
  OPEN_REDIRECT: {
    pattern: /(redirect\(.*request|location\.href\s*=.*request|window\.location\s*=.*user)/gi,
    type: 'Open Redirect',
    severity: 'medium' as const,
    cwe: 'CWE-601'
  },
  
  // Insufficient input validation
  NO_INPUT_VALIDATION: {
    pattern: /(request\.(GET|POST|form|args|json)|req\.(body|query|params))(?!.*validate|.*check|.*sanitize)/gi,
    type: 'Insufficient Input Validation',
    severity: 'high' as const,
    cwe: 'CWE-20'
  },
  
  // Insecure random
  INSECURE_RANDOM: {
    pattern: /(Math\.random\(\)|random\.random\(\)).*(?:password|token|key|secret)/gi,
    type: 'Insecure Randomness',
    severity: 'high' as const,
    cwe: 'CWE-330'
  },
  
  // SSRF
  SSRF: {
    pattern: /(requests\.get\(.*user|fetch\(.*req\.|urllib\.request\.urlopen\(.*user)/gi,
    type: 'Server-Side Request Forgery (SSRF)',
    severity: 'high' as const,
    cwe: 'CWE-918'
  }
};

/**
 * Performs static analysis on code to detect potential vulnerabilities
 */
export function analyzeCodeStatic(code: string): Vulnerability[] {
  const vulnerabilities: Vulnerability[] = [];
  const lines = code.split('\n');

  for (const [key, pattern] of Object.entries(VULNERABILITY_PATTERNS)) {
    const matches = code.matchAll(pattern.pattern);
    
    for (const match of matches) {
      // Find line number
      const position = match.index || 0;
      const lineNumber = code.substring(0, position).split('\n').length;
      
      vulnerabilities.push({
        type: pattern.type,
        severity: pattern.severity,
        description: `Potential ${pattern.type} detected. This could allow attackers to compromise the system.`,
        location: `Line ${lineNumber}`,
        cwe: pattern.cwe
      });
    }
  }

  return vulnerabilities;
}

/**
 * Analyzes execution output for runtime vulnerabilities
 */
export function analyzeExecutionOutput(output: string, error?: string): Vulnerability[] {
  const vulnerabilities: Vulnerability[] = [];

  // Check for error patterns that indicate security issues
  const errorPatterns = [
    { pattern: /Permission denied|Access denied|Unauthorized/i, type: 'Authorization Error', severity: 'medium' as const },
    { pattern: /SQL syntax error|database error/i, type: 'SQL Error', severity: 'high' as const },
    { pattern: /stack trace|traceback/i, type: 'Information Disclosure', severity: 'low' as const },
    { pattern: /timeout|resource exhausted/i, type: 'Potential DoS', severity: 'medium' as const },
  ];

  const fullOutput = `${output}\n${error || ''}`;

  for (const { pattern, type, severity } of errorPatterns) {
    if (pattern.test(fullOutput)) {
      vulnerabilities.push({
        type,
        severity,
        description: `Runtime ${type} detected during execution. This may indicate a security issue.`,
        location: 'Runtime Execution'
      });
    }
  }

  return vulnerabilities;
}

/**
 * Calculates overall risk level based on vulnerabilities
 */
export function calculateRiskLevel(vulnerabilities: Vulnerability[]): 'low' | 'medium' | 'high' | 'critical' {
  if (vulnerabilities.length === 0) return 'low';
  
  const hasCritical = vulnerabilities.some(v => v.severity === 'critical');
  const hasHigh = vulnerabilities.some(v => v.severity === 'high');
  const hasMedium = vulnerabilities.some(v => v.severity === 'medium');

  if (hasCritical) return 'critical';
  if (hasHigh || vulnerabilities.length >= 5) return 'high';
  if (hasMedium || vulnerabilities.length >= 3) return 'medium';
  return 'low';
}

